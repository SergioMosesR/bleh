<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Indodax Personal Analyzer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #1e1e2f;
        color: #e0e0e0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: #2a2a3d;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        padding: 20px;
      }
      h1 {
        text-align: center;
        color: #40c4ff;
        margin-bottom: 20px;
      }
      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 10px;
      }
      #searchInput {
        flex: 1;
        padding: 12px;
        border: 1px solid #444;
        border-radius: 8px;
        font-size: 16px;
        background: #333;
        color: #e0e0e0;
        transition: border-color 0.3s;
      }
      #searchInput:focus {
        border-color: #40c4ff;
        outline: none;
      }
      #showFavorites {
        padding: 12px 20px;
        background-color: #40c4ff;
        color: #1e1e2f;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }
      #showFavorites:hover {
        background-color: #0288d1;
      }
      .table-container {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #444;
      }
      th {
        background-color: #333;
        color: #b0b0b0;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      tr:hover {
        background-color: #3a3a4d;
        transition: background-color 0.2s;
      }
      .price-up {
        color: #4caf50;
      }
      .price-down {
        color: #f44336;
      }
      .favorite-btn,
      .detail-btn {
        cursor: pointer;
        font-size: 18px;
        background: none;
        border: none;
        color: #666;
        transition: color 0.3s;
      }
      .favorite-btn.favorited {
        color: #ffca28;
      }
      .detail-btn {
        color: #40c4ff;
      }
      .detail-btn:hover {
        color: #0288d1;
      }
      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 10px;
      }
      .pagination button {
        padding: 8px 16px;
        background-color: #333;
        border: 1px solid #444;
        border-radius: 8px;
        color: #e0e0e0;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .pagination button:hover {
        background-color: #444;
      }
      .pagination button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .last-update {
        text-align: center;
        color: #888;
        font-size: 14px;
        margin-top: 10px;
      }
      #detailModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: #2a2a3d;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 900px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        color: #e0e0e0;
      }
      .close-btn {
        float: right;
        cursor: pointer;
        font-size: 24px;
        color: #888;
      }
      .close-btn:hover {
        color: #e0e0e0;
      }
      .detail-section {
        margin-bottom: 30px;
      }
      .detail-section h3 {
        color: #40c4ff;
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
      }
      .order-buy {
        color: #4caf50;
      }
      .order-sell {
        color: #f44336;
      }
      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
        }
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }
        thead tr {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }
        tr {
          margin-bottom: 15px;
          border: 1px solid #444;
          border-radius: 8px;
          padding: 10px;
        }
        td {
          border: none;
          position: relative;
          padding-left: 50%;
        }
        td:before {
          position: absolute;
          top: 6px;
          left: 6px;
          width: 45%;
          padding-right: 10px;
          white-space: nowrap;
          font-weight: bold;
          color: #b0b0b0;
        }
        td:nth-of-type(1):before {
          content: "Pair";
        }
        td:nth-of-type(2):before {
          content: "Harga Terakhir";
        }
        td:nth-of-type(3):before {
          content: "High 24h";
        }
        td:nth-of-type(4):before {
          content: "Low 24h";
        }
        td:nth-of-type(5):before {
          content: "Volume";
        }
        td:nth-of-type(6):before {
          content: "Buy";
        }
        td:nth-of-type(7):before {
          content: "Sell";
        }
        td:nth-of-type(8):before {
          content: "Ticker Time";
        }
        td:nth-of-type(9):before {
          content: "Favorite";
        }
        td:nth-of-type(10):before {
          content: "Detail";
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Indodax Market</h1>

      <div class="controls">
        <input
          type="text"
          id="searchInput"
          placeholder="Cari pair (misal: btc_idr, eth)"
        />
        <button id="showFavorites">Tampilkan Favorit Saja</button>
      </div>

      <div class="table-container">
        <table id="tickerTable">
          <thead>
            <tr>
              <th>Pair</th>
              <th>Harga Terakhir (IDR)</th>
              <th>High 24h</th>
              <th>Low 24h</th>
              <th>Volume</th>
              <th>Buy</th>
              <th>Sell</th>
              <th>Ticker Time</th>
              <th>Favorite</th>
              <th>Detail</th>
            </tr>
          </thead>
          <tbody id="tickerBody"></tbody>
        </table>
        <div class="pagination">
          <button id="prevPage" class="disabled">Prev</button>
          <span id="pageInfo">Page 1 of 1</span>
          <button id="nextPage" class="disabled">Next</button>
        </div>
        <div class="last-update" id="lastUpdate"></div>
      </div>
    </div>

    <div id="detailModal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2 id="detailPair"></h2>
        <div id="detailInfo"></div>
        <div id="orderBookSection" class="detail-section"></div>
        <div id="tradeHistorySection" class="detail-section"></div>
      </div>
    </div>

    <script>
      let favorites =
        JSON.parse(localStorage.getItem("indodaxFavorites")) || [];
      let allTickers = [];
      let showOnlyFavorites = false;
      let currentPage = 1;
      const itemsPerPage = 10;

      // Fungsi fetch data dari API Indodax
      async function fetchWithProxy(url) {
        let apiUrl =
          "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
        let fallbackUrl = "https://thingproxy.freeboard.io/fetch/" + url;
        try {
          let response = await fetch(apiUrl, {
            method: "GET",
            headers: { Accept: "application/json" },
          });
          if (!response.ok) {
            response = await fetch(fallbackUrl, {
              method: "GET",
              headers: { Accept: "application/json" },
            });
          }
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (error) {
          throw new Error(`Gagal fetch ${url}: ${error.message}`);
        }
      }

      async function fetchTickers() {
        try {
          const data = await fetchWithProxy("https://indodax.com/api/tickers");
          console.log(
            "Data diterima (jumlah pairs):",
            Object.keys(data.tickers || {}).length
          );

          if (!data.tickers) {
            throw new Error("Respons tidak valid: Tidak ada data tickers");
          }

          allTickers = Object.entries(data.tickers).map(([pair, ticker]) => ({
            pair,
            ...ticker,
          }));

          updateTable();

          document.getElementById(
            "lastUpdate"
          ).innerHTML = `Terakhir diupdate: ${new Date().toLocaleString(
            "id-ID"
          )} <br><span style="color: #4caf50;">Status: Berhasil (Data: ${
            allTickers.length
          } pairs)</span>`;
        } catch (error) {
          console.error("Error lengkap:", error);
          document.getElementById(
            "lastUpdate"
          ).innerHTML = `Gagal: ${error.message} <br><span style="color: #f44336;">Lihat Console (F12) untuk detail. Mencoba lagi dalam 30 detik...</span>`;
        }
      }

      // Fungsi update tabel dengan pagination
      function updateTable() {
        const tbody = document.getElementById("tickerBody");
        tbody.innerHTML = "";
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();

        let filteredTickers = allTickers.filter((ticker) => {
          const matchesSearch = ticker.pair.toLowerCase().includes(searchTerm);
          const isFavorite = favorites.includes(ticker.pair);
          return matchesSearch && (!showOnlyFavorites || isFavorite);
        });

        const totalPages = Math.ceil(filteredTickers.length / itemsPerPage);
        document.getElementById(
          "pageInfo"
        ).textContent = `Page ${currentPage} of ${totalPages}`;
        document
          .getElementById("prevPage")
          .classList.toggle("disabled", currentPage === 1);
        document
          .getElementById("nextPage")
          .classList.toggle("disabled", currentPage === totalPages);

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        filteredTickers.slice(start, end).forEach((ticker) => {
          const row = tbody.insertRow();
          const lastPrice = parseFloat(ticker.last || 0);
          const buyPrice = parseFloat(ticker.buy || 0);
          const priceClass = lastPrice > buyPrice ? "price-up" : "price-down";
          row.innerHTML = `
                    <td>${ticker.pair}</td>
                    <td class="${priceClass}">${formatRupiah(lastPrice)}</td>
                    <td>${formatRupiah(ticker.high || 0)}</td>
                    <td>${formatRupiah(ticker.low || 0)}</td>
                    <td>${parseFloat(ticker.vol_idr || 0).toLocaleString()}</td>
                    <td>${formatRupiah(buyPrice)}</td>
                    <td>${formatRupiah(ticker.sell || 0)}</td>
                    <td>${new Date(ticker.server_time * 1000).toLocaleString(
                      "id-ID"
                    )}</td>
                    <td><button class="favorite-btn ${
                      favorites.includes(ticker.pair) ? "favorited" : ""
                    }" data-pair="${ticker.pair}">‚≠ê</button></td>
                    <td><button class="detail-btn" data-pair="${
                      ticker.pair
                    }">üìä</button></td>
                `;
        });
      }

      // Fungsi format Rupiah
      function formatRupiah(amount) {
        if (isNaN(amount) || amount === 0) return "Rp 0";
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(amount);
      }

      // Fungsi tampilkan detail dengan order book & trade history
      async function showDetail(pair) {
        const ticker = allTickers.find((t) => t.pair === pair);
        if (!ticker) return;

        document.getElementById(
          "detailPair"
        ).textContent = `Detail untuk ${pair.toUpperCase()}`;
        document.getElementById("detailInfo").innerHTML = `
        <p>Harga Terakhir: ${formatRupiah(ticker.last)}</p>
        <p>High 24h: ${formatRupiah(ticker.high)}</p>
        <p>Low 24h: ${formatRupiah(ticker.low)}</p>
        <p>Volume: ${parseFloat(ticker.vol_idr).toLocaleString()}</p>
    `;

        // ===== Fetch Order Book (modifikasi tampilan kiri-kanan) =====
        let orderBookSection = document.getElementById("orderBookSection");
        try {
          const orderData = await fetchWithProxy(
            `https://indodax.com/api/${pair}/depth`
          );
          const buys = orderData.buy.slice(0, 10);
          const sells = orderData.sell.slice(0, 10);

          const sellTable = `
            <h4 style="text-align:center; color:#f44336;">Sell Orders</h4>
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th style="text-align:right;">Harga (IDR)</th>
                        <th style="text-align:right;">Qty</th>
                        <th style="text-align:right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${sells
                      .map(([price, qty]) => {
                        const total = price * qty;
                        return `
                            <tr class="order-sell">
                                <td style="text-align:right;">${formatRupiah(
                                  price
                                )}</td>
                                <td style="text-align:right;">${parseFloat(
                                  qty
                                ).toFixed(4)}</td>
                                <td style="text-align:right;">${formatRupiah(
                                  total
                                )}</td>
                            </tr>`;
                      })
                      .join("")}
                </tbody>
            </table>
        `;

          const buyTable = `
            <h4 style="text-align:center; color:#4caf50;">Buy Orders</h4>
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th style="text-align:right;">Harga (IDR)</th>
                        <th style="text-align:right;">Qty</th>
                        <th style="text-align:right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${buys
                      .map(([price, qty]) => {
                        const total = price * qty;
                        return `
                            <tr class="order-buy">
                                <td style="text-align:right;">${formatRupiah(
                                  price
                                )}</td>
                                <td style="text-align:right;">${parseFloat(
                                  qty
                                ).toFixed(4)}</td>
                                <td style="text-align:right;">${formatRupiah(
                                  total
                                )}</td>
                            </tr>`;
                      })
                      .join("")}
                </tbody>
            </table>
        `;

          orderBookSection.innerHTML = `
            <h3>Order Book (Top 10)</h3>
            <div style="display:flex; gap:20px; justify-content:space-between; flex-wrap:wrap;">
                <div style="flex:1; min-width:350px;">${sellTable}</div>
                <div style="flex:1; min-width:350px;">${buyTable}</div>
            </div>
        `;
        } catch (error) {
          orderBookSection.innerHTML = `<p>Gagal memuat order book: ${error.message}</p>`;
        }

        // ===== Fetch Trade History =====
        let tradeHistorySection = document.getElementById(
          "tradeHistorySection"
        );
        try {
          const tradeData = await fetchWithProxy(
            `https://indodax.com/api/${pair}/trades`
          );
          tradeHistorySection.innerHTML = `
            <h3>History Jual Beli (50 Terakhir)</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Harga (IDR)</th>
                        <th>Jumlah</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${tradeData
                      .map((trade) => {
                        const total = trade.price * trade.amount;
                        const typeClass =
                          trade.type === "buy" ? "price-up" : "price-down";
                        return `
                            <tr>
                                <td>${new Date(
                                  trade.date * 1000
                                ).toLocaleString("id-ID")}</td>
                                <td class="${typeClass}">${trade.type.toUpperCase()}</td>
                                <td>${formatRupiah(trade.price)}</td>
                                <td>${parseFloat(trade.amount).toFixed(4)}</td>
                                <td>${formatRupiah(total)}</td>
                            </tr>`;
                      })
                      .join("")}
                </tbody>
            </table>
        `;
        } catch (error) {
          tradeHistorySection.innerHTML = `<p>Gagal memuat history trades: ${error.message}</p>`;
        }

        document.getElementById("detailModal").style.display = "flex";
      }

      // Event listeners
      document.getElementById("searchInput").addEventListener("input", () => {
        currentPage = 1;
        updateTable();
      });
      document.getElementById("showFavorites").addEventListener("click", () => {
        showOnlyFavorites = !showOnlyFavorites;
        document.getElementById("showFavorites").textContent = showOnlyFavorites
          ? "Tampilkan Semua"
          : "Tampilkan Favorit Saja";
        currentPage = 1;
        updateTable();
      });
      document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          updateTable();
        }
      });
      document.getElementById("nextPage").addEventListener("click", () => {
        const totalPages = Math.ceil(allTickers.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          updateTable();
        }
      });
      document.getElementById("tickerBody").addEventListener("click", (e) => {
        if (e.target.classList.contains("favorite-btn")) {
          const pair = e.target.dataset.pair;
          const index = favorites.indexOf(pair);
          if (index > -1) {
            favorites.splice(index, 1);
            e.target.classList.remove("favorited");
          } else {
            favorites.push(pair);
            e.target.classList.add("favorited");
          }
          localStorage.setItem("indodaxFavorites", JSON.stringify(favorites));
          updateTable();
        } else if (e.target.classList.contains("detail-btn")) {
          showDetail(e.target.dataset.pair);
        }
      });
      document.querySelector(".close-btn").addEventListener("click", () => {
        document.getElementById("detailModal").style.display = "none";
      });
      window.addEventListener("click", (e) => {
        if (e.target === document.getElementById("detailModal")) {
          document.getElementById("detailModal").style.display = "none";
        }
      });

      // Load awal dan auto-refresh setiap 30 detik
      fetchTickers();
      setInterval(fetchTickers, 30000);
    </script>
  </body>
</html>
